---
export interface Props {
  username: string;
  showArtwork?: boolean;
  size?: 'normal' | 'large';
}

const { username, showArtwork = true, size = 'normal' } = Astro.props;
---

<div id="lastfm-now-playing" class="space-y-3">
  <div id="lastfm-content" class="flex items-start gap-3">
    <div id="album-art" class="hidden flex-shrink-0">
      <!-- Album artwork will be inserted here -->
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400">
        <svg
          class="w-4 h-4 animate-pulse text-green-500 flex-shrink-0"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M12 6a6 6 0 0 0-6 6c0 1.66.67 3.16 1.76 4.24l1.42-1.42A4 4 0 0 1 8 12a4 4 0 0 1 4-4V6z"
            opacity="0.6"></path>
          <path
            d="M12 2a10 10 0 0 0-10 10c0 2.76 1.12 5.26 2.93 7.07l1.42-1.42A8 8 0 0 1 4 12a8 8 0 0 1 8-8V2z"
            opacity="0.3"></path>
        </svg>
        <span id="track-info" class="italic">Loading...</span>
      </div>
      <div id="track-details" class="mt-1 space-y-0.5 hidden">
        <!-- Additional track details will be shown here -->
      </div>
      <div id="user-stats" class="mt-2 hidden">
        <!-- User stats will be shown here -->
      </div>
      <div id="recent-tracks" class="mt-2 hidden">
        <!-- Recent tracks will be shown here -->
      </div>
      <div id="top-artists" class="mt-2 hidden">
        <!-- Top artists will be shown here -->
      </div>
    </div>
  </div>
</div>

<script define:vars={{ username, showArtwork, size }}>
  async function fetchNowPlaying() {
    try {
      console.log('Fetching Last.fm data for:', username);

      const url = `/api/lastfm.json?username=${username}`;
      console.log('Fetching from API endpoint:', url);

      const response = await fetch(url);
      console.log('Response status:', response.status);

      const data = await response.json();
      console.log('Last.fm API response:', data);

      const trackElement = document.getElementById('track-info');
      const albumArtElement = document.getElementById('album-art');
      const trackDetailsElement = document.getElementById('track-details');
      const userStatsElement = document.getElementById('user-stats');
      const recentTracksElement = document.getElementById('recent-tracks');
      const topArtistsElement = document.getElementById('top-artists');

      if (!trackElement) return;

      if (data.error) {
        console.error('Last.fm API error:', data.message);
        trackElement.textContent = 'API error';
        return;
      }

      // Handle recent tracks
      if (data.recenttracks && data.recenttracks.track) {
        // Handle both array and single object response
        const tracks = Array.isArray(data.recenttracks.track)
          ? data.recenttracks.track
          : [data.recenttracks.track];

        if (tracks.length > 0) {
          const track = tracks[0];
          const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';

          console.log('Track found:', track.name, 'by', track.artist['#text']);
          console.log('Now playing:', isNowPlaying);

          // Show album artwork if available
          if (showArtwork && albumArtElement && track.image) {
            const imageSize = size === 'large' ? 'extralarge' : 'large';
            const artworkSize = size === 'large' ? 'w-24 h-24' : 'w-16 h-16';

            const selectedImage =
              track.image.find((img) => img.size === imageSize) ||
              track.image.find((img) => img.size === 'large') ||
              track.image[track.image.length - 1];

            if (selectedImage && selectedImage['#text']) {
              albumArtElement.innerHTML = `
                <img 
                  src="${selectedImage['#text']}" 
                  alt="${track.album ? track.album['#text'] : 'Album artwork'}"
                  class="${artworkSize} rounded-md shadow-sm object-cover"
                  loading="lazy"
                />
              `;
              albumArtElement.classList.remove('hidden');
            }
          }

          if (isNowPlaying) {
            trackElement.innerHTML = `<span class="text-green-600 dark:text-green-400">Now playing</span>`;
          } else {
            // Show last played track with timestamp
            const date = track.date ? new Date(track.date.uts * 1000) : null;
            const timeAgo = date ? getTimeAgo(date) : '';
            trackElement.innerHTML = `<span class="text-gray-500">Last played${timeAgo ? ' · ' + timeAgo : ''}</span>`;
          }

          // Show track details
          if (trackDetailsElement) {
            const truncateClass = size === 'large' ? '' : 'truncate';
            const titleSize = size === 'large' ? 'text-base' : 'text-sm';
            const artistSize = size === 'large' ? 'text-sm' : 'text-xs';

            trackDetailsElement.innerHTML = `
              <div class="${titleSize} font-medium text-gray-900 dark:text-gray-100 ${truncateClass}">${track.name}</div>
              <div class="${artistSize} text-gray-600 dark:text-gray-400 ${truncateClass}">${track.artist['#text']}</div>
              ${track.album && track.album['#text'] ? `<div class="${artistSize} text-gray-500 dark:text-gray-500 ${truncateClass}">${track.album['#text']}</div>` : ''}
            `;
            trackDetailsElement.classList.remove('hidden');
          }

          // Show user stats if available
          if (userStatsElement && data.user) {
            const playcount = parseInt(data.user.playcount || '0').toLocaleString();
            const registeredDate = new Date(parseInt(data.user.registered?.unixtime || '0') * 1000);
            const memberSince = registeredDate.getFullYear();

            userStatsElement.innerHTML = `
              <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                <span>${playcount} scrobbles</span>
                <span>·</span>
                <span>Since ${memberSince}</span>
              </div>
            `;
            userStatsElement.classList.remove('hidden');
          }

          // Show recent tracks (mini timeline)
          if (recentTracksElement && tracks.length > 1) {
            const recentTracksList = tracks.slice(1, 4); // Show up to 3 recent tracks
            const recentTracksHtml = recentTracksList
              .map((t) => {
                const date = t.date ? new Date(t.date.uts * 1000) : null;
                const timeAgo = date ? getTimeAgo(date) : '';
                return `
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                  <span class="text-gray-400 dark:text-gray-500">${timeAgo}:</span> ${t.artist['#text']} - ${t.name}
                </div>
              `;
              })
              .join('');

            if (recentTracksHtml) {
              recentTracksElement.innerHTML = `
                <div class="pt-2 border-t border-gray-200 dark:border-gray-700 space-y-0.5">
                  <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Recent tracks</div>
                  ${recentTracksHtml}
                </div>
              `;
              recentTracksElement.classList.remove('hidden');
            }
          }

          // Show top artists for the week
          if (topArtistsElement && data.topartists && data.topartists.artist) {
            const artists = Array.isArray(data.topartists.artist)
              ? data.topartists.artist.slice(0, 3)
              : [data.topartists.artist];

            if (artists.length > 0) {
              const artistsList = artists
                .map(
                  (artist, index) =>
                    `<span class="text-gray-600 dark:text-gray-400">${artist.name} (${artist.playcount})</span>`
                )
                .join(' · ');

              topArtistsElement.innerHTML = `
                <div class="text-xs">
                  <span class="text-gray-500 dark:text-gray-500">This week:</span> ${artistsList}
                </div>
              `;
              topArtistsElement.classList.remove('hidden');
            }
          }
        } else {
          trackElement.textContent = 'No recent tracks';
        }
      } else {
        trackElement.textContent = 'No recent tracks';
      }
    } catch (error) {
      console.error('Error fetching Last.fm data:', error);
      const trackElement = document.getElementById('track-info');
      if (trackElement) {
        trackElement.textContent = 'Unable to load track info';
      }
    }
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60,
    };

    for (const [name, secondsInInterval] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInInterval);
      if (interval >= 1) {
        return interval === 1 ? `1 ${name} ago` : `${interval} ${name}s ago`;
      }
    }

    return 'just now';
  }

  // Function to initialize Last.fm widget with retry
  function initializeLastFm() {
    // Check if element exists
    const trackElement = document.getElementById('track-info');

    if (!trackElement) {
      // Retry after a short delay if element isn't ready
      console.log('[Last.fm] Element not ready, retrying in 100ms...');
      setTimeout(initializeLastFm, 100);
      return;
    }

    // Element is ready, fetch data
    fetchNowPlaying();
    // Update every 10 seconds for better real-time updates
    setInterval(fetchNowPlaying, 10000);
  }

  // Ensure DOM is ready before initializing
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeLastFm);
  } else {
    // DOM is already ready, but use requestAnimationFrame to ensure rendering is complete
    requestAnimationFrame(initializeLastFm);
  }
</script>
